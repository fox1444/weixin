<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>会议详情</title>
    <!--<link href="/View_Mobile/js/layer/need/layer.css" rel="stylesheet" />
    <link href="/View_Mobile/CSS/add.css?ver=2" rel="stylesheet" />
    <link href="/View_Mobile/CSS/szhlextend.css?ver=20160904" rel="stylesheet" />-->
    <link href="/View_Mobile/CSS/tobaccoHtml.css" rel="stylesheet" />
</head>
<body ms-controller="Hydetail">
    <div class="hy_wrap">
        <div class="invitation">
            INVITATION
        </div>
        <div class="logo">
        </div>
        <div class="title">
            {{modelData.Title|html}}
        </div>
        <div class="date">
            时间：{{modelData.StartTime|date('M月d日H:mm')}} - {{modelData.EndTime|date('M月d日H:mm')}}
        </div>
        <div class="location">
            地址：{{modelData.Name}}
        </div>
        <div class="default_block">
            <div class="ewrcode">
                <img ms-attr-src="{{tempmodel.EWMcode}}" />
            </div>
            <div class="gobutton">
                <span ms-on-click="view_detail()">进入会议</span>
            </div>
        </div>
        <div class="input_block">
            <div class="phonenumber">
                <input type="text" id="phone_input" placeholder="请输入手机号" ms-duplex="phonenumber">
            </div>
            <div class="gobutton2">
                <span id="phone_input_submit" ms-on-click="go_detail()">进入会议</span>
            </div>
        </div>
    </div>
    <script src="/View_Mobile/js/layer/layer.m.js"></script>
    <script type='text/javascript' src='//g.alicdn.com/sj/lib/zepto/zepto.min.js' charset='utf-8'></script>
    <script src="/View_Mobile/JS/avalon1.47.js"></script>
    <script src="/View_Mobile/JS/raty/jquery.raty.js?v=1.3"></script>
    <script src="/View_Mobile/js/ComFunJS.js"></script>
    <script>
        var tempmodel = avalon.define({
            $id: "Hydetail",
            ColumnData: [],
            name: "会议管理",
            iswf: true,//是否属于流程表单
            tpData: [],
            userpl: 0,
            usertype: "",
            isjl: "",
            Name: "",
            wximg: "",
            EWMcode: "",
            phonenumber: '',
            phonenumbererrorMsg: '',
            dataid: ComFunJS.getQueryString('id'),
            RoomID: ComFunJS.getQueryString("rid"),
            view_detail: function () {
                var pnum = ComFunJS.getCookie("input_phonenumber");
                if (pnum) {
                    $.getJSON('/API/VIEWAPINOLOGIN.ashx?Action=HYGL_GETHYGLMODELWITHPHONE', { P1: tempmodel.dataid, P2: pnum }, function (resultData) {
                        if (resultData.ErrorMsg == "") {
                            if (resultData.Result[0]) {
                                tempmodel.phonebackData = resultData.Result[0];//查询有结果返回
                                location.href = "/View_Mobile/UI/HyDetail_step.html?id=" + tempmodel.dataid + "&r=" + Math.random();
                            }
                            else {
                                $('.input_block').show();
                                $('.default_block').hide();
                            }
                        }
                    })
                }
                else {
                    $('.input_block').show();
                    $('.default_block').hide();
                    $('#phone_input').focus();
                }

            },
            go_detail: function () {
                if ($.trim(tempmodel.phonenumber) == "") {
                    msg = "请输入手机号";
                    ComFunJS.winwarning(msg);
                    return;
                }

                $.getJSON('/API/VIEWAPINOLOGIN.ashx?Action=HYGL_GETHYGLMODELWITHPHONE', { P1: tempmodel.dataid, P2: tempmodel.phonenumber }, function (resultData) {

                    if (resultData.ErrorMsg == "") {
                        if (resultData.Result[0]) {
                            tempmodel.phonebackData = resultData.Result[0];
                            //查询有结果返回
                            ComFunJS.setCookieMinute("input_phonenumber", tempmodel.phonenumber, 10);
                            location.href = "/View_Mobile/UI/HyDetail_step.html?id=" + tempmodel.dataid + "&r=" + Math.random();
                        }
                        else {
                            ComFunJS.winwarning("未查询到您的参会记录");
                            return;
                        }
                    }
                })


            },
            inittemp: function (strId) {
                strId = tempmodel.dataid;
                if (strId) {

                    $.getJSON('/API/VIEWAPINOLOGIN.ashx?Action=HYGL_GETHYGLMODELNOLOGIN', { P1: strId }, function (resultData) {
                        if (resultData.ErrorMsg == "") {
                            tempmodel.modelData = resultData.Result[0];
                            tempmodel.tpData = resultData.Result1;

                            if (resultData.Result.JLUser) {
                                var JLUserList = resultData.Result.JLUser.split(',');

                                var un = ComFunJS.getCookie("username");
                                if (JLUserList.indexOf(un) != -1 || resultData.Result.FQUser.split(',').indexOf(un) != -1) {
                                    tempmodel.isjl = "1";
                                }
                            }
                            tempmodel.EWMcode = "http://qr.liantu.com/api.php?text=" + ComFunJS.yuming + "/View_Mobile/UI/HyDetail_start.html?id=" + tempmodel.modelData.ID + "&bg=ffffff&fg=007457&w=600&logo=" + ComFunJS.yuming + "/View_Mobile/images/tobacco-logo-icon.png";

                            //ComFunJS.uploadimgnew(tempmodel.tpData);
                            ComFunJS.viewimg(tempmodel.tpData, '1');

                            if (tempmodel.modelData.StartTime && tempmodel.modelData.StartTime.length > 16) {
                                tempmodel.modelData.StartTime = tempmodel.modelData.StartTime.substring(0, 16);
                            }
                            if (tempmodel.modelData.StartTime) {
                                var ss = tempmodel.modelData.StartTime.split(' ');
                                var ss1 = ss[0].split('-');
                                var ss2 = ss[1].split(':');
                                var hh = ss2[0];
                                if (hh.substring(0, 1) == "0") { hh = hh.substring(1, 1); }
                                $("#StartTime").datetimePicker({
                                    value: [ss1[0], ss1[1], ss1[2], hh, ss2[1]]
                                });
                            }
                            if (tempmodel.modelData.EndTime && tempmodel.modelData.EndTime.length > 16) {
                                tempmodel.modelData.EndTime = tempmodel.modelData.EndTime.substring(0, 16);
                            }

                            if (tempmodel.modelData.EndTime) {
                                var ss = tempmodel.modelData.EndTime.split(' ');
                                var ss1 = ss[0].split('-');
                                var ss2 = ss[1].split(':');
                                var hh = ss2[0];
                                if (hh.substring(0, 1) == "0") { hh = hh.substring(1, 1); }
                                $("#EndTime").datetimePicker({
                                    value: [ss1[0], ss1[1], ss1[2], hh, ss2[1]]
                                });
                            }

                            setTimeout(" ComFunJS.initForm()", 500)
                        }
                    })
                }
                else {
                    var dates = ComFunJS.getnowdate("yyyy-mm-dd-hh-mm").split('-');
                    $("#StartTime").datetimePicker({
                        value: [dates[0], dates[1], dates[2], dates[3], dates[4]]
                    });
                    $("#EndTime").datetimePicker({
                        value: [dates[0], dates[1], dates[2], dates[3], dates[4]]
                    });

                    tempmodel.modelData.StartTime = dates[0] + "-" + dates[1] + "-" + dates[2] + " " + dates[3] + ":" + dates[4];
                    tempmodel.modelData.EndTime = dates[0] + "-" + dates[1] + "-" + dates[2] + " " + dates[3] + ":" + dates[4];

                    ComFunJS.uploadimgnew();
                    ComFunJS.initForm();
                }

                $('#phone_input').on('focus', function () {
                    var _this = $('#phone_input_submit');
                    setTimeout(function () {
                        _this.scrollIntoView(true);
                        _this.scrollIntoViewIfNeeded();
                    }, 200);
                })
            },//初始化
            modelData: { "RoomID": "", "Title": "", "Details": "", "StartTime": "", "EndTime": "", "CYUser": "", "FQUser": "", "TXSJ": "-1", "HYJL": "", "Remark": "", "JLFiles": "", "Files": "", "JLUser": "", "ZCUser": "", "SXUser": "", "HYFW": "" },
            phonebackData: { "RoomID": "", "Title": "", "Details": "", "StartTime": "", "EndTime": "", "CYUser": "", "FQUser": "", "TXSJ": "-1", "HYJL": "", "Remark": "", "JLFiles": "", "Files": "", "JLUser": "", "ZCUser": "", "SXUser": "", "HYFW": "" }

        });

        avalon.ready(function () {
            tempmodel.inittemp();
        })

        $(window).on("load resize", function () {
            var h = document.documentElement.clientHeight || window.innerHeight;
            $(".hy_wrap").css("height", h);
        });
    </script>
</body>
</html>
